---
import BaseLayout from './BaseLayout.astro';

interface Props {
  title: string;
  pubDate: Date | string;
  mood?: string;
}

const { title, pubDate, mood } = Astro.props;

let dateObject: Date;
if (!pubDate) {
  dateObject = new Date();
} else if (pubDate instanceof Date) {
  dateObject = pubDate;
} else {
  dateObject = new Date(pubDate);
}

if (isNaN(dateObject.getTime())) {
  console.error('Invalid date:', pubDate);
  dateObject = new Date();
}

const formattedDate = dateObject.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout title={`${title} | Vault`} description="Private journal entry">
  <div id="entry-gate" class="entry-gate">
    <div class="vault-icon">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
    </div>
    <h1>Protected Entry</h1>
    <p>This journal entry is private. Please unlock the vault first.</p>
    <a href="/vault" class="vault-link">Go to Vault</a>
  </div>

  <article id="entry-content" class="entry" style="display: none;">
    <header class="entry-header">
      <a href="/vault" class="back-link">&larr; Back to Vault</a>
      <time datetime={dateObject.toISOString()}>{formattedDate}</time>
      <h1>{title}</h1>
      {mood && <span class="mood-tag">{mood}</span>}
    </header>
    <div class="entry-content">
      <slot />
    </div>
  </article>
</BaseLayout>

<script is:inline>
  const gate = document.getElementById('entry-gate');
  const content = document.getElementById('entry-content');

  if (sessionStorage.getItem('vault-unlocked') === 'true') {
    gate.style.display = 'none';
    content.style.display = 'block';
  }
</script>

<style>
  .entry-gate {
    text-align: center;
    padding: 4rem 2rem;
    max-width: 480px;
    margin: 0 auto;
  }

  .vault-icon {
    color: var(--uva-blue);
    margin-bottom: 1.5rem;
  }

  .entry-gate h1 {
    font-size: 1.75rem;
    margin-bottom: 0.75rem;
  }

  .entry-gate p {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
  }

  .vault-link {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    font-size: 0.9375rem;
    font-weight: 500;
    color: white;
    background: var(--uva-blue);
    border-radius: 4px;
    text-decoration: none;
    transition: background 0.15s ease;
  }

  .vault-link:hover {
    background: var(--uva-blue-light);
    color: white;
  }

  .entry {
    max-width: 680px;
    margin: 0 auto;
  }

  .entry-header {
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-light);
  }

  .back-link {
    display: inline-block;
    font-size: 0.875rem;
    color: var(--text-muted);
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: color 0.15s ease;
  }

  .back-link:hover {
    color: var(--uva-blue);
  }

  .entry-header time {
    display: block;
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .entry-header h1 {
    font-size: 2rem;
    line-height: 1.2;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
  }

  .mood-tag {
    display: inline-block;
    font-size: 0.8125rem;
    color: var(--uva-orange);
    background: rgba(229, 114, 0, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 3px;
  }

  .entry-content {
    font-size: 1.125rem;
    line-height: 1.8;
  }

  .entry-content :global(p) {
    margin-bottom: 1.5rem;
  }

  .entry-content :global(h2) {
    font-size: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .entry-content :global(ul),
  .entry-content :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .entry-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .entry-content :global(blockquote) {
    border-left: 3px solid var(--uva-orange);
    padding-left: 1.25rem;
    margin: 1.75rem 0;
    font-style: italic;
    color: var(--text-secondary);
  }
</style>
